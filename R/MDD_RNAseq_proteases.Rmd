---
title: "Analysis of proteases in MDD integrated modules"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=FALSE, cache.lazy = FALSE, message=FALSE, warning = FALSE, fig.height=10, fig.width=12)

suppressMessages(library(tidyverse))
library(readxl)
library(ComplexHeatmap)
library(circlize)

create_pdfs <- FALSE
write_csvs <- FALSE

```

Read in the file Human_Proteases.xlsx  
Filter the MDD data to the protease genes and annotate with type     
 

```{r MDD_protease_genes}

#make a list with a character vector of gene names from each module
ligand_order <-  c("PBS", "HGF", "OSM", "EGF","BMP2+EGF", "IFNG+EGF", "TGFB+EGF")
condition_order <- paste0(rep(ligand_order, each = 2), rep(c("_24", "_48"), times = length(ligand_order)))

protease <- read_excel("../integrated_analysis/Data/Human_Proteases.xlsx")

#make a list with a character vector of gene names from each module
get_genes_from_excel <- function(sheet_name, file_name){
  genes <- read_excel(file_name, sheet = sheet_name) %>%
    filter(Type == "RNAseq") %>%
    mutate(module = sheet_name) %>%
    select(module, feature, Set)
  if(nrow(genes) == 0) return(NULL)
  return(genes)
}

file_name <- "../tables/MDD_int_rr_combined18_tables.xlsx"
MDD <- map(excel_sheets(file_name), get_genes_from_excel, file_name = file_name) %>%
  bind_rows() %>%
  mutate(module = case_when(
    module %in% c("module_3", "module_4") ~ "module_3+4",
    module %in% c("module_8", "module_17") ~ "module_8+17",
    module %in% c("module_10", "module_15") ~ "module_10+15",
    module %in% c("module_6", "module_16") ~ "module_6+16",
    TRUE ~ module
  ))

module_proteases <- MDD %>%
  right_join(protease, by = c("feature" = "Gene"))

write_csv(module_proteases, "../tables/MDD_proteases.csv")

```

```{r figures}
#barplot of proteases in each module

p_figure_count <- module_proteases %>%
  drop_na %>%
  mutate(module = str_remove(module, "module_")) %>%
  ggplot( aes(x = module)) +
  geom_bar()

p_figure_count

protease_counts <- MDD %>%
  group_by(module) %>%
  summarise(MDD_count = n(), .groups = "drop") %>%
  left_join(module_proteases, by = "module") %>%
  group_by(module, MDD_count) %>%
  summarise(protease_count = n() - 1, .groups = "drop") %>%
  mutate(protease_prop = protease_count/MDD_count,
         module = str_remove(module, "module_"))
  
p_figure_count <- protease_counts %>%
  ggplot( aes(x = module, y = protease_count)) +
  geom_col()

p_figure_prop <- protease_counts %>%
  ggplot( aes(x = module, y = protease_prop)) +
  geom_col()

p_figure_count
p_figure_prop

pdf("../plots/MDD_protease_counts.pdf")
print(p_figure_count)
print(p_figure_prop)
res <- dev.off()

#module 6+16 has pathway enrichment in neutrophil degranulation. Please check how many of the features in neutrophil degranulation are proteases.
np_degran <- read_delim("../integrated_analysis/Data/Participating Molecules [R-HSA-6798695].tsv", 
    "\t", escape_double = FALSE, trim_ws = TRUE) %>%
  mutate(Gene = str_remove(MoleculeName, ".* ")) %>%
  select(Gene) %>%
  distinct()

np_degran_proteases <- np_degran %>%
  left_join(protease, by = "Gene") %>%
  mutate(protease = case_when(!is.na(Type) ~TRUE,
                              TRUE ~FALSE)) %>%
  select(Gene, protease) %>%
    distinct()
  
#Module 6+16 Reactome Neutrophil degranulation proteases
np_degran_in_MDD <- MDD %>%
  right_join(np_degran, by = c("feature" = "Gene")) %>%
  drop_na()
np_degran_in_MDD_proteases <- np_degran_in_MDD %>%
  right_join(protease, by = c("feature" = "Gene")) %>%
  drop_na()

np_degran_in_MDD_proteases_counts <- np_degran_in_MDD_proteases %>%
  group_by(module) %>%
  summarise(counts = n())

#generalize to read all of the Reactome participating molecule files

read_Reactome_PM_files <- function(filename){
   path_members <- read_delim(filename, "\t", escape_double = FALSE, trim_ws = TRUE,col_types = cols(
  MoleculeType = col_character(),
  Identifier = col_character(),
  MoleculeName = col_character(),
  X4 = col_logical()
)) %>%
  mutate(Gene = str_remove(MoleculeName, ".* "),
         Pathway = str_extract(filename,"R-HSA-.*"),
         Pathway = str_remove(Pathway, "].tsv")) %>%
  select(Gene, Pathway) %>%
  distinct()
}

sig_pathway_proteins_m6p16 <- dir("../integrated_analysis/Data/", pattern = "Participating",full.names = TRUE) %>%
  map_dfr(read_Reactome_PM_files)

spp_proteases_m6p16 <- sig_pathway_proteins_m6p16 %>%
  inner_join(protease, by = "Gene") %>%
  distinct()

mdd_spp_proteases_m6p16 <- spp_proteases_m6p16 %>%
  inner_join(MDD, by = c("Gene" = "feature")) %>%
  filter(module == "module_6+16")

```

There are `r nrow(sig_pathway_proteins_m6p16)` unique genes in the `r length(unique(sig_pathway_proteins_m6p16$Pathway))` significant Reactome pathways in module 6+16 and `r nrow(spp_proteases_m6p16)` of them create proteases.

There are `r nrow(mdd_spp_proteases_m6p16)` Reactome pathway protease genes in MDD module 6+16.

The distribution of the Neutrophil degranulation proteases in the MDD modules is:  

```{r np_table}
np_degran_in_MDD_proteases_counts

```





