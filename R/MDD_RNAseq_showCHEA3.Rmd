---
title: "CHEA3 Enrichment of MDD `r FEATURENAME`"
author: "Daniel Derrick"
date: "9/18/2020"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    df_print: paged
  html_notebook:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DT)
# FEATURE     <- "combinedFeature_CHEA3"
# FEATURENAME <- "combined module RNAseq features"
# FEATURETYPE <- "module"
# FDR_THRESHOLD <- 0.1
featureDirectory <- sprintf("../RNAseq/Data/Enrichment/%s/All_Libraries", FEATURE)
```

This script is for producing summaries and visualizations of TF enrichment scores from CHEA3

## Description of input genes

This analysis is looking for TF enrichment in the `r FEATURENAME`.
The number of RNAseq features in each `r FEATURETYPE` is shown below.

```{r}
a <- sapply(moduleRNAseqFeatures, length) %>%
  data.frame %>%
  rownames_to_column("group") %>%
  rename(n_genes = ".") %>%
  mutate_if(is.character, as.factor) %>%
  mutate_if(is.factor, fct_inorder)

a %>%
  ggplot(aes(group, n_genes)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ylab("# Input Genes") +
  xlab(str_to_title(FEATURETYPE))

a %>%
  dplyr::rename("# Input Genes" = n_genes)
```

## Summary of significant CHEA3 TFs

For each `r FEATURETYPE`, all genes were submitted to [CHEA3](https://maayanlab.cloud/chea3/) via
their API. Results from all TF libraries were returned. Significant TFs were identified by selecting those
with an adjusted p-value < `r FDR_THRESHOLD`.

```{r, fig.width=8}
listLong <-
  Reduce(bind_rows,
         lapply(moduleCHEA3ResultsList, function(x) {
  x <-
    mapply(function(X, X_NM) {
      X <-
        X %>%
        mutate(Library = X_NM)
      X
      },
      X = x, X_NM = names(x),
      SIMPLIFY = FALSE)
  })
  ) %>%
  mutate(`Query Name` = fct_inorder(as.factor(`Query Name`))) %>%
  mutate(Library = as.factor(Library)) %>%
  mutate(Library = fct_relevel(Library,
                               grep("ChIP", levels(Library), value = TRUE),
                               grep("ChIP", levels(Library), invert = TRUE, value = TRUE)
                               )) %>% 
  mutate(FDR = as.numeric(FDR),
         Rank = as.numeric(Rank))
```

## Sum of significant TFs in each CHEA3 library

```{r, fig.width=8}
listLong %>%
  filter(FDR < FDR_THRESHOLD, .preserve = TRUE) %>%
  group_by(`Query Name`, Library) %>%
  summarize(n = n()) %>%
  ggplot(aes(`Query Name`, n)) +
  geom_col(position = "dodge") +
  ylab(sprintf("# TFs with FDR < %s", FDR_THRESHOLD)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  xlab(str_to_title(FEATURETYPE)) +
  facet_wrap(~Library)
```

As a table:

```{r}
listLong %>%
  filter(FDR < FDR_THRESHOLD, .preserve = TRUE) %>%
  group_by(`Query Name`, Library) %>%
  summarize(n = n()) %>%
  pivot_wider(names_from = "Library", values_from = n) %>% 
  dplyr::select(`Query Name`, contains("ChIP"), everything())
```

## Libraries ordered by # of groups with â‰¥1 significant TF

```{r}
temp <- unique(listLong$`Query Name`)

listLong %>%
  filter(FDR < FDR_THRESHOLD, .preserve = TRUE) %>%
  group_by(`Query Name`, Library) %>%
  summarize(n = n()) %>%
  ungroup %>%
  group_by(Library) %>%
  summarize(n_groups_w_sig_TFs = n(),
            groups_without_sig_TFs = str_remove_all(
              paste(setdiff(temp, `Query Name`),
                    collapse = ", "),
              "module_")) %>%
  arrange(desc(n_groups_w_sig_TFs))
```

## Significant TFs, ordered by FDR

All significant (FDR < `r FDR_THRESHOLD`) TFs are shown in the table below. Rows
are ordered by FDR (increasing).

```{r, warning=FALSE}
listLong %>%
  filter(FDR < FDR_THRESHOLD) %>%
  arrange(FDR) %>%
  dplyr::select(-Score, -Overlapping_Genes) %>%
  datatable
```

