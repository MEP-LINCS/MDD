---
title: "MDD standard figures"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE,  message=FALSE, warning = FALSE, fig.height=10, fig.width=10)

suppressMessages(library(tidyverse))
suppressMessages(library(ComplexHeatmap))
suppressMessages(library(circlize))
library(umap)
library(pheatmap)
#library(synapser)

```

###Overview
These figures are derived from data downloaded from the LINCS Molecular Deep Dive files on Synapse https://www.synapse.org/#!Synapse:syn2862345/wiki/588244.  

The data have been filtered for QC issues and normalized to the EGF timepoints.  

```{r functions}
#' Read an assay's csv or tsv data file 
load_data <- function(assay_name){
  file_name <- dir("Data",pattern = paste0(assay_name,".*Level3"),recursive = TRUE, full.names = TRUE)
  if(!length(file_name) == 1) stop("There was not one ", assay_name, " data file found")
    
  if(str_detect(file_name, "csv")) {
    df <- read_csv(file_name)
  } else if (str_detect(file_name, "tsv")){
    df <- read_tsv(file_name)
  } else stop("The data file ",file_name, " must be a csv or tsv file type")
} #end of function

plot_heatmap <- function(df, assay_name, show_row_names = FALSE){

#temporary function for Ligand_2 metadata
  label_ligand_2 <- function(x) {
    ligand_2 <- rep("None", times = length(x))
    ligand_2[x %in% c("BMP2", "IFNG", "TGFB")] <- "EGF"
    return(ligand_2)
  }
  
  windsorize_probs <- df %>%
    select(-Feature) %>%
  unlist %>%
  quantile(probs = c(.02,.98))
  
  #Set the order of the columns
  condition_order <-  paste(rep(c("PBS","BMP2", "IFNG", "TGFB", "HGF", "OSM", "EGF"), each = 5), rep(c(1, 4 ,8, 24, 48), times = 7), sep = "_") %>%
    intersect(colnames(df))
  
  #Arrange columns by standard condition order
  df <- df %>%
    select(Feature, condition_order)

  #Create the heatmap column annotations
  df_ann <- colnames(df) %>%
    intersect(condition_order) %>%
    enframe(value = "Condition") %>%
    mutate(Ligand = str_remove(Condition, "_.*"),
           Timepoint = str_remove(Condition, ".*_"),
           Timepoint = as.numeric(Timepoint),
           Ligand_2 = label_ligand_2(Ligand)) %>%
    select(-Condition, -name) %>%
    as.data.frame()
  
  haTop = HeatmapAnnotation(df = df_ann,
                            col = list(Ligand = c("PBS" = "#8dd3c7", "BMP2" = "#ffffb3", "IFNG" = "#bebada", "TGFB" = "#b3de69", "HGF" = "#80b1d3", "OSM" = "#fdb462", "EGF" = "#fb8072"),
                                       Timepoint = c("1" = "azure1", "4" = "azure2", "8" = "azure3", "24" = "azure4", "48" = "black"), 
                                       Ligand_2 = c("EGF" = "#fc8d62", "None" = "#8da0cb")))
  
  #Create the heatmap
  Heatmap(matrix = select(df, -Feature),
          name = "abundance",
          top_annotation = haTop,
          show_row_names = show_row_names,
          show_column_names = FALSE,
          cluster_columns = FALSE,
          col = colorRamp2(c(windsorize_probs[1], 0, windsorize_probs[2]), c("blue", "white", "red")),
          na_col = "grey")
}

plot_umap <- function(df, assay_name){
  #Generate a 2d scatterplot of the UMAP dimensions
  #Use size to represent timepoint, dot in center to represent ligand_2 == EGF
 #temporary function for Ligand_2 metadata
  label_ligand_2 <- function(x) {
    ligand_2 <- rep("None", times = length(x))
    ligand_2[x %in% c("BMP2", "IFNG", "TGFB")] <- "EGF"
    return(ligand_2)
  }
  
  ligand_cols <- c("PBS" = "#8dd3c7",
                   "BMP2" = "#ffffb3",
                   "IFNG" = "#bebada",
                   "TGFB" = "#b3de69",
                   "HGF" = "#80b1d3",
                   "OSM" = "#fdb462",
                   "EGF" = "#fb8072")
  
   ligand_2_cols <- c("EGF" = "#ff0000",
                     "None" = "#00000000")

   #Create annotation values
  df_ann <- df %>%
    select(-Feature) %>%
    colnames() %>%
    enframe(value = "Condition") %>%
    mutate(Ligand = str_remove(Condition, "_.*"),
           Timepoint = str_remove(Condition, ".*_"),
           Timepoint = as.numeric(Timepoint),
           Ligand_2 = label_ligand_2(Ligand)) %>%
    select(-Condition, -name) %>%
    as.data.frame()

   df_mat <- df %>%
    select(-Feature) %>%
    t() %>%
  as.matrix()
  colnames(df_mat) <- df$Feature

  df_UMAP <- umap(df_mat)$layout %>%
  data.frame() %>%
  rename(UMAP_1 = X1,
         UMAP_2 = X2) %>%
    cbind(df_ann)
  
p <- ggplot(df_UMAP, aes(x = UMAP_1,
                         y = UMAP_2,
                         size = Timepoint,
                         colour = Ligand,
                         fill = Ligand_2)) +
    geom_point() +
  geom_point(shape = 21, stroke = 4) +
  scale_color_manual( values = ligand_cols) +
  scale_fill_manual( values = ligand_2_cols) +
  scale_size(breaks = c(1,4,8,24,48), trans = "exp") +
  labs(title = paste("UMAP embedding of ", assay_name, " data"))
p
  
}

plot_pca <- function(df){
    #Generate a 2d scatterplot of the the first two principal components
  #Use size to represent timepoint, a dot in center to represent ligand_2 == EGF
 #temporary function for Ligand_2 metadata
  label_ligand_2 <- function(x) {
    ligand_2 <- rep("None", times = length(x))
    ligand_2[x %in% c("BMP2", "IFNG", "TGFB")] <- "EGF"
    return(ligand_2)
  }
  
  ligand_cols <- c("PBS" = "#8dd3c7",
                   "BMP2" = "#ffffb3",
                   "IFNG" = "#bebada",
                   "TGFB" = "#b3de69",
                   "HGF" = "#80b1d3",
                   "OSM" = "#fdb462",
                   "EGF" = "#fb8072")
  
   ligand_2_cols <- c("EGF" = "#ff0000",
                     "None" = "#00000000")

   #Create annotation values
  df_ann <- df %>%
    select(-Feature) %>%
    colnames() %>%
    enframe(value = "Condition") %>%
    mutate(Ligand = str_remove(Condition, "_.*"),
           Timepoint = str_remove(Condition, ".*_"),
           Timepoint = as.numeric(Timepoint),
           Ligand_2 = label_ligand_2(Ligand)) %>%
    select(-Condition, -name) %>%
    as.data.frame()

   df_mat <- df %>%
    select(-Feature) %>%
    t() %>%
  as.matrix()
  colnames(df_mat) <- df$Feature

  df_pca <- prcomp(df_mat)$x %>%
  data.frame() %>%
    cbind(df_ann)
  
p <- ggplot(df_pca, aes(x = PC1,
                         y = PC2,
                         size = Timepoint,
                         colour = Ligand,
                         fill = Ligand_2)) +
    geom_point() +
  geom_point(shape = 21, stroke = 4) +
  scale_color_manual( values = ligand_cols) +
  scale_fill_manual( values = ligand_2_cols) +
  scale_size(breaks = c(1,4,8,24,48), trans = "exp") +
  labs(title = paste("PCA of ", assay_name, " data"))
p
  
}

plot_introspect <- function(df, assay_name){
  #calculate correlations across the condtions and show in a heatmap
#temporary function for Ligand_2 metadata
  label_ligand_2 <- function(x) {
    ligand_2 <- rep("None", times = length(x))
    ligand_2[x %in% c("BMP2", "IFNG", "TGFB")] <- "EGF"
    return(ligand_2)
  }
  
  windsorize_probs <- df %>%
    select(-Feature) %>%
  unlist %>%
  quantile(probs = c(.005,.995))
  
  #Set the order of the columns
  condition_order <-  paste(rep(c("PBS","BMP2", "IFNG", "TGFB", "HGF", "OSM", "EGF"), each = 5), rep(c(1, 4 ,8, 24, 48), times = 7), sep = "_") %>%
    intersect(colnames(df))
  
  #Arrange columns by standard condition order
  df <- df %>%
    select(Feature, condition_order)
  #Create the heatmap column annotations
  df_ann <- colnames(df) %>%
    intersect(condition_order) %>%
    enframe(value = "Condition") %>%
    mutate(Ligand = str_remove(Condition, "_.*"),
           Timepoint = str_remove(Condition, ".*_"),
           Timepoint = as.numeric(Timepoint),
           Ligand_2 = label_ligand_2(Ligand)) %>%
    select(-Condition, -name) %>%
    as.data.frame()
  
  haTop = HeatmapAnnotation(df = df_ann,
                            col = list(Ligand = c("PBS" = "#8dd3c7", "BMP2" = "#ffffb3", "IFNG" = "#bebada", "TGFB" = "#b3de69", "HGF" = "#80b1d3", "OSM" = "#fdb462", "EGF" = "#fb8072"),
                                       Timepoint = c("1" = "azure1", "4" = "azure2", "8" = "azure3", "24" = "azure4", "48" = "black"), 
                                       Ligand_2 = c("EGF" = "#fc8d62", "None" = "#8da0cb")))
  
  haRow <- rowAnnotation(df = df_ann,
                            col = list(Ligand = c("PBS" = "#8dd3c7", "BMP2" = "#ffffb3", "IFNG" = "#bebada", "TGFB" = "#b3de69", "HGF" = "#80b1d3", "OSM" = "#fdb462", "EGF" = "#fb8072"),
                                       Timepoint = c("1" = "azure1", "4" = "azure2", "8" = "azure3", "24" = "azure4", "48" = "black"), 
                                       Ligand_2 = c("EGF" = "#fc8d62", "None" = "#8da0cb")))
  
  #Create the heatmap
  Heatmap(matrix = cor(select(df, -matches("Feature"))),
          name = "abundance",
          top_annotation = haTop,
          right_annotation = haRow,
          show_row_names = FALSE,
          show_column_names = FALSE,
          cluster_rows = FALSE,
          cluster_columns = FALSE,
          col = colorRamp2(c(windsorize_probs[1], 0, windsorize_probs[2]), c("blue", "white", "red")),
          na_col = "grey")
}

plot_circos <- function(df){
  
}
```


```{r rppa_figures}

rppa <- load_data("RPPA")

#Select data and translate from RPPA terms to common terms
df <- rppa %>%
  select(Antibody, Ligand_TimePoint, EGFNorm) %>%
  rename(Feature = Antibody,
         Condition = Ligand_TimePoint,
         Value = EGFNorm) %>%
  spread(key = Condition, value = Value) %>%
 select(-ctrl_0) %>%
  mutate_if(is.numeric, log2)

plot_heatmap(df, assay_name = "RPPA")

plot_umap(df, assay_name = "RPPA")

plot_introspect(df, assay_name = "RPPA")

```

```{r IF_figures}

immunofluoresence <- load_data("IF")

#Select data and translate from IF terms to common terms
df <- immunofluoresence %>%
  mutate(Collection_condition = paste(Collection, Ligand, TimePoint, sep = "_")) %>%
  select(Collection_condition, Replicate, matches("EGFNorm")) %>%
  group_by(Collection_condition) %>%
  summarise_if(is.numeric, mean) %>%
  ungroup() %>%
  gather(key = "Feature") %>%

  gather(-Collection, -Ligand, -TimePoint)
  rename(Feature = Antibody,
         Condition = Ligand_TimePoint,
         Value = EGFNorm) %>%
  spread(key = Feature, value = Value) %>%
  filter(!Condition == "ctrl_0")

res <- plot_heatmap(df, assay = "RPPA")
res

```

```{r cycIF_figures}


```

```{r rnaSeq_figures}


```

```{r GCP_figures}


```

```{r ATACseq_figures}


```

```{r l1000_figures}


```